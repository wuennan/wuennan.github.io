<!DOCTYPE html>
<html lang="zh-CN"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="description" content=" - https://www.wuennan.cn/posts/%E9%AB%98%E6%95%88%E8%BF%90%E7%BB%B4/ansible%E4%BD%BF%E7%94%A8/">
    <meta name="author" content="Wuennan - https://www.wuennan.cn/">
    
    <meta name="msvalidate.01" content="B46311949B856F2A7015F366FB3CE878" />
    <title></title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    
    <link rel="stylesheet" href="https://www.wuennan.cn/style.min.ab1affb864595dc8034de89700f09bcace7cadcc73a0e800a66ae137a366f17d.css">
    
    <script type="text/javascript" src="/main.js" defer></script>
    
</head>
<body class="active-animate cool">
        <div id="header"><div class="container-header">
    <div id="vars" class="container-vars" style="display: none;">
	{
		"isSingleColumnOfPostList": true,
		"hasFoldAllCodeBlocks": false,
		"svgColor": "",
		"en": false,
		"dark": false
	}
</div>
    <h1 class="title">
        
            
            
        
    </h1>

    <div class="container-breadcrumb-nav">
    
    <div class="breadcrumb-nav-bar">
        <div><a href="/"><svg t="1656411084410" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2954" width="16" height="16"><path d="M947.5 390.6l-377-290c-34.5-26.5-82.6-26.5-117.1 0l-377 290c-14 10.8-16.6 30.9-5.9 44.9 10.8 14 30.9 16.6 44.9 5.9l28.5-21.9V768c0 88.2 71.8 160 160 160h80c35.3 0 64-28.7 64-64V640c0-17.6 14.4-32 32-32h64c17.6 0 32 14.4 32 32v224c0 35.3 28.7 64 64 64h80c88.2 0 160-71.8 160-160V419.4l28.5 21.9c5.8 4.5 12.7 6.6 19.5 6.6 9.6 0 19.1-4.3 25.4-12.5 10.8-13.9 8.2-34-5.8-44.8zM816 768c0 52.9-43.1 96-96 96h-80V640c0-52.9-43.1-96-96-96h-64c-52.9 0-96 43.1-96 96v224h-80c-52.9 0-96-43.1-96-96V370.2l284.5-218.8c11.5-8.8 27.5-8.8 39 0L816 370.2V768z" fill="#6c757d" p-id="2955"></path></svg></a></div>
        <div><a href="/nav"><svg t="1656411531924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5827" width="16" height="16"><path d="M849.59197473 125.23018519L139.22930586 391.72854662a23.35052669 23.35052669 0 0 0-14.95414244 21.65490745c-0.12257519 9.70384955 5.61801843 18.46795771 14.40255493 22.04306141l318.42928099 129.25528056 119.51057092 320.39047893c3.06437293 8.23295069 10.35758221 13.89182751 18.7335381 14.87242563l2.7170774 0.14300521a22.79893918 22.79893918 0 0 0 21.20546682-15.36272638l259.51158924-729.54564933a23.8612558 23.8612558 0 0 0-5.31158128-24.55584682 22.3290685 22.3290685 0 0 0-23.9021142-5.43415649zM793.65694081 211.64552314l-196.63064161 552.75171747-91.91077952-246.37564122-253.62799211-102.96295445 542.16941324-203.4131218z" p-id="5828" fill="#6c757d"></path></svg></a></div>
        <div><a href="/search"><svg t="1656411627509" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1730" width="14" height="14"><path d="M469.333333 85.333333c211.968 0 384 172.032 384 384s-172.032 384-384 384-384-172.032-384-384 172.032-384 384-384z m0 682.666667c164.992 0 298.666667-133.674667 298.666667-298.666667 0-165.034667-133.674667-298.666667-298.666667-298.666666-165.034667 0-298.666667 133.632-298.666666 298.666666 0 164.992 133.632 298.666667 298.666666 298.666667z m362.026667 3.029333l120.704 120.661334-60.373333 60.373333-120.661334-120.704 60.330667-60.330667z" p-id="1731" fill="#6c757d"></path></svg></a></div>
        <div><a href="/posts"><svg t="1656411724198" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5655" width="12" height="12"><path d="M811.705761 1024H212.294239c-93.1199 0-174.823046-87.570975-174.823046-187.387854V162.322018C37.471193 69.776145 112.604921 0 212.294239 0H596.190595l7.015883 5.93161c111.74388 95.479788 185.857116 170.741078 279.614824 266.093304 29.65805 30.040735 61.165743 62.122454 96.436499 97.393211l7.271006 7.334787v459.859234c-0.063781 99.816879-81.703145 187.387854-174.823046 187.387854zM212.294239 49.94033c-72.391155 0-124.882716 47.261538-124.882716 112.381688v674.290128c0 71.94469 59.507443 137.383743 124.882716 137.383743h599.411522c65.311492 0 124.882716-65.439053 124.882716-137.383743V397.417876c-32.528184-32.464404-61.73977-62.250016-89.356836-90.377328-90.951355-92.418312-163.278729-165.957521-269.601245-257.163999H212.294239z" fill="#6c757d" p-id="5656"></path><path d="M936.588477 449.526752h-212.326129c-99.753099 0-187.324073-81.703145-187.324073-174.823046V49.94033a25.002055 25.002055 0 0 1 49.94033 0v224.763376c0 65.311492 65.502834 124.882716 137.383743 124.882716h212.326129a25.002055 25.002055 0 1 1 0 49.94033z" fill="#6c757d" p-id="5657"></path></svg></a></div>
        <div><a href="/archive"><svg t="1656411795742" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7334" width="12" height="12"><path d="M884.224 522.24H504.32V141.824c0-16.896-13.824-30.72-30.72-30.72-120.32 0-233.472 47.616-317.952 134.144S26.112 445.952 29.184 566.784c2.56 114.688 49.152 222.72 131.072 304.128 81.92 81.408 189.952 128 304.64 130.56h10.24c117.76 0 227.84-45.568 312.32-128.512 86.528-85.504 133.632-199.68 132.608-321.024-0.512-2.048-1.536-29.696-35.84-29.696z m-140.288 307.712c-74.752 73.728-173.056 112.64-277.504 110.592-205.824-4.608-370.688-169.472-375.296-374.784-3.072-104.448 35.84-202.752 108.544-277.504 65.536-67.072 151.552-107.52 243.712-114.688v378.88c0 16.896 13.824 30.72 30.72 30.72 129.024 0 311.296 0 382.976 0.512-6.144 93.184-46.08 179.712-113.152 246.272z" fill="#6c757d" p-id="7335"></path><path d="M603.136 11.264c-8.192-0.512-15.872 3.072-22.016 8.704-5.632 5.632-9.216 13.824-9.216 22.016v378.88c0 16.896 13.824 30.72 30.72 30.72h378.88c16.896 0 30.72-13.824 30.72-30.72 0-223.744-183.808-407.552-409.088-409.6z m30.208 378.88V74.24c167.424 16.384 301.056 150.016 315.904 315.904h-315.904z" fill="#6c757d" p-id="7336"></path></svg></a></div>
        <div id="light-dark" style="cursor: pointer;"><a><svg t="1656411842215" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5086" width="12" height="12"><path d="M1007.492874 384.513055c-8.795694-34.58307-21.189627-67.666874-36.682043-99.05151-2.698679-5.397358-10.894667-3.498287-10.894666 2.598728v0.299853c0 32.484098-6.896624 63.868734-19.890263 92.554691-10.694764 23.488501-25.487523 45.077933-43.978471 64.068635-41.779547 42.679107-99.05151 66.967217-158.722299 67.26707-61.869712 0.299853-119.941284-24.188159-162.920244-68.966238-40.280281-41.979449-62.56937-98.251902-62.269516-156.323473 0.399804-59.270984 23.588452-114.94373 65.567901-156.823229 19.59041-19.59041 42.179351-35.082826 66.667364-46.077443C672.956643 71.166451 704.041426 64.469729 736.125719 64.469729h1.299364c6.097015 0 8.096037-8.096037 2.598728-10.794715C708.739126 37.982696 675.655322 25.488812 641.172203 16.493216 599.492607 5.598549 555.714038-0.098662 510.536154 0.001289 222.37722 0.700947-7.41029 237.38508 0.185992 525.444064c7.096526 271.667008 225.889418 490.559851 497.456474 497.856279 287.559228 7.796183 524.14341-220.891864 525.842579-508.551044 0.299853-44.977981-5.297407-88.656599-15.992171-130.236244z m-83.15929 301.552378c-22.588942 53.27392-54.873137 101.250434-95.953027 142.330323-41.179841 41.179841-89.056403 73.464036-142.330324 95.953027-55.172991 23.288599-113.744317 35.182777-174.314666 35.182777s-119.141675-11.794226-174.314666-35.182777c-53.27392-22.588942-101.250434-54.873137-142.330323-95.953027-41.179841-41.179841-73.464036-89.056403-95.953027-142.330323C75.749001 630.892442 63.954774 572.221164 63.954774 511.750767s11.794226-119.141675 35.182777-174.314666c22.588942-53.27392 54.873137-101.250434 95.953027-142.330323 41.179841-41.179841 89.056403-73.464036 142.330323-95.953027C392.593892 75.7642 451.26517 63.969974 511.735567 63.969974c13.99315 0 27.886348 0.599706 41.679596 1.89907C489.246577 118.643209 448.266638 198.704016 448.266638 288.360126c0 159.022152 128.836929 287.859081 287.859081 287.859081 89.156354 0 168.817357-40.580134 221.691473-104.149015 1.099462 13.09359 1.699168 26.387082 1.699168 39.680575 0 60.470397-11.794226 119.141675-35.182776 174.314666z" p-id="5087" fill="#6c757d"></path></svg></a></div>
        
    </div>

    
</div>

            <div id="toc">📜</div>
        
    
    
</div>
</div>
        <div id="content">















<div class="container-main 
     container-page 
">

    <div class="desc">
        
        <span>
            
            <svg t="1656736000388" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7409" width="12" height="12"><path d="M524.885333 338.986667L200.362667 663.466667c-17.28 15.274667-27.989333 36.693333-29.696 56.234666v133.76l130.730666 0.085334c22.784-1.621333 43.989333-12.245333 61.013334-31.701334l322.688-322.645333-160.213334-160.213333z m60.373334-60.330667l160.170666 160.213333 102.144-102.144a19.712 19.712 0 0 0 0-27.861333L715.093333 176.426667a19.456 19.456 0 0 0-27.605333 0L585.258667 278.613333zM701.312 85.333333c27.946667 0 54.741333 11.136 74.282667 30.848l132.309333 132.309334a105.045333 105.045333 0 0 1 0 148.565333L424.874667 879.957333c-29.824 34.346667-72.106667 55.466667-120.448 58.794667H85.333333v-42.666667l0.128-179.84c3.626667-44.970667 24.576-86.826667 56.448-114.944l485.12-485.034666A104.789333 104.789333 0 0 1 701.269333 85.333333z" p-id="7410" fill="#adb5bd"></path></svg>
            0001-01-01&nbsp;
        </span>
        <span>
            
            <svg t="1656737270708" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="23838" width="11" height="11"><path d="M824.264 95.36c0-23.859 25.043-44.16 48.902-44.16s49.714 20.301 49.714 44.16v190.08c0 23.859-19.054 52.868-42.913 52.868h-190.08c-23.859 0-46.696-25.96-46.696-49.819s22.55-46.249 46.409-46.249h82.025C702.344 175.534 610.22 155.853 512 155.853c-206.775 0-360.398 149.372-360.398 356.147 0 206.775 153.623 358.23 360.398 358.23 206.775 0 357.467-151.455 357.467-358.23 0-23.859 23.634-50.706 53.413-50.706 29.78 0 49.92 26.847 49.92 50.706 0 254.493-206.307 460.8-460.8 460.8-254.493 0-460.8-206.307-460.8-460.8C51.2 257.507 257.507 51.2 512 51.2c122.4 0 226.684 33.296 312.264 117.369 0.358 0.351 0.358-24.052 0-73.209z" p-id="23839" fill="#adb5bd"></path></svg>
            0001-01-01&nbsp;&nbsp;&nbsp;
        </span>
        <span>
            
            <svg t="1656737548689" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="33866" width="12" height="12"><path d="M832.038608 64.662657H192.030028C121.255125 64.662657 63.940169 121.98845 63.940169 192.694717v446.793671C63.940169 710.205493 121.255125 767.643272 192.030028 767.643272h133.353183a63.940169 63.940169 0 0 1 55.219742 31.576328l76.099638 129.83828c12.358154 21.093031 33.790754 31.626903 55.216129 31.626903s42.832688-10.544709 55.198067-31.619678l76.222461-129.870792a63.940169 63.940169 0 0 1 55.212517-31.551041h133.54103c70.576219 0 127.732228-57.289669 127.732227-127.800865V192.391272C959.825022 121.85479 902.643727 64.662657 832.038608 64.662657zM895.884854 639.842407A63.85347 63.85347 0 0 1 832.092795 703.703103h-133.54103a127.753903 127.753903 0 0 0-110.349172 63.09847l-76.222461 129.856342a0.274545 0.274545 0 0 1 0-0.050574h-0.032512s-0.021675 0.061411-0.032512 0.061412l-76.1466-129.85273A127.804477 127.804477 0 0 0 325.383211 703.703103H192.030028A64.207489 64.207489 0 0 1 127.880338 639.488388V192.694717A64.102729 64.102729 0 0 1 192.030028 128.602826h640.00858A63.799284 63.799284 0 0 1 895.884854 192.391272v447.451135z" fill="#adb5bd" p-id="33867"></path><path d="M608.154093 288.092004A31.970084 31.970084 0 0 0 576.184009 320.062089v160.078006l-134.650049-179.278119A31.970084 31.970084 0 0 0 384.002258 320.062089v255.760676a31.970084 31.970084 0 0 0 63.940169 0v-159.958796l134.650048 179.274507a31.970084 31.970084 0 0 0 57.531703-19.200113V320.062089a31.970084 31.970084 0 0 0-31.970085-31.970085z" fill="#adb5bd" p-id="33868"></path></svg>
            7351 字</span>&nbsp;
        <span>
            
            <svg t="1656737462334" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="32892" width="12" height="12"><path d="M512 74.666667C270.933333 74.666667 74.666667 270.933333 74.666667 512S270.933333 949.333333 512 949.333333 949.333333 753.066667 949.333333 512 753.066667 74.666667 512 74.666667z m0 810.666666c-204.8 0-373.333333-168.533333-373.333333-373.333333S307.2 138.666667 512 138.666667 885.333333 307.2 885.333333 512 716.8 885.333333 512 885.333333z" p-id="32893" fill="#adb5bd"></path><path d="M695.466667 567.466667l-151.466667-70.4V277.333333c0-17.066667-14.933333-32-32-32s-32 14.933333-32 32v238.933334c0 12.8 6.4 23.466667 19.2 29.866666l170.666667 81.066667c4.266667 2.133333 8.533333 2.133333 12.8 2.133333 12.8 0 23.466667-6.4 29.866666-19.2 6.4-14.933333 0-34.133333-17.066666-42.666666z" p-id="32894" fill="#adb5bd"></path></svg>
            15 分钟</span>
            <div class="container-ctgtag">
	<div class="taxonomy">
		
		<div class="ctg">
			
			
		</div>
		<div class="tag">
			
			
			
		</div>
	</div>
</div>
        
    </div>
    
    <div class="toc">
        
        <div class="page-operation">
            <div><a href="#"><img src="/imgs/icons/arrow-up-circle.svg" alt=""></a></div>
            <div><a href="https://www.wuennan.cn/posts/linux%E5%9F%BA%E7%A1%80/1.-%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AE%89%E8%A3%85centos7/"><img src="/imgs/icons/arrow-left-circle.svg" alt=""></a></div>
            <div></div>
        </div>
        
        <nav id="TableOfContents">
  <ul>
    <li><a href="#一ansible配置文件">一、Ansible配置文件</a>
      <ul>
        <li>
          <ul>
            <li><a href="#1-配置文件优先级">1. 配置文件优先级</a></li>
            <li><a href="#2-ansible-inventory">2. Ansible inventory</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#二ansible-ad-hoc">二、Ansible Ad-Hoc</a>
      <ul>
        <li>
          <ul>
            <li><a href="#1-ansible-ad-hoc语法">1. Ansible Ad-Hoc语法</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#三ansilbe常用模块">三、Ansilbe常用模块</a>
      <ul>
        <li>
          <ul>
            <li><a href="#1-模块帮助文档">1. 模块帮助文档</a></li>
            <li><a href="#2-command模块">2. command模块</a></li>
            <li><a href="#3-shell模块">3. shell模块</a></li>
            <li><a href="#4-yum模块">4. yum模块</a></li>
            <li><a href="#5-copy模块">5. copy模块</a></li>
            <li><a href="#6--service--systemd模块">6.  service | systemd模块</a></li>
            <li><a href="#7-file模块">7. file模块</a></li>
            <li><a href="#8-group模块">8. group模块</a></li>
            <li><a href="#9-user模块">9. user模块</a></li>
            <li><a href="#10-mount模块">10. mount模块</a></li>
            <li><a href="#11-cron模块">11. cron模块</a></li>
            <li><a href="#12-firewalld模块">12. firewalld模块</a></li>
            <li><a href="#13-selinux模块">13. selinux模块</a></li>
            <li><a href="#14-get_url模块">14. get_url模块</a></li>
            <li><a href="#15-yum_repository模块">15. yum_repository模块</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#四ansible-playbook">四、Ansible Playbook</a>
      <ul>
        <li>
          <ul>
            <li><a href="#1-playbook简介">1. Playbook简介</a></li>
            <li><a href="#2-使用ansible安装并配置nfs服务">2. 使用ansible安装并配置nfs服务</a></li>
            <li><a href="#3-使用ansible安装并配置nginx服务">3. 使用ansible安装并配置nginx服务</a></li>
            <li><a href="#4-使用ansibleplaybook方式构建lap架构">4. 使用AnsiblePlaybook方式构建LAP架构</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#五ansible-varialbes">五、Ansible varialbes</a>
      <ul>
        <li>
          <ul>
            <li><a href="#1-在playbook中定义变量">1. 在Playbook中定义变量</a></li>
            <li><a href="#2-在inventory主机清单中定义">2. 在inventory主机清单中定义</a></li>
            <li><a href="#3-通过外置传参定义变量">3. 通过外置传参定义变量</a></li>
            <li><a href="#4-变量优先级">4. 变量优先级</a></li>
            <li><a href="#5-变量注册register">5. 变量注册register</a></li>
            <li><a href="#6-facts变量">6. facts变量</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#六ansible-流程控制">六、Ansible 流程控制</a>
      <ul>
        <li>
          <ul>
            <li><a href="#1-判断语句">1. 判断语句</a></li>
            <li><a href="#2-循环语句">2. 循环语句</a></li>
            <li><a href="#3-触发器handlers">3. 触发器handlers</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#七ansible调试">七、Ansible调试</a>
      <ul>
        <li>
          <ul>
            <li><a href="#1-tag标签">1. tag标签</a></li>
            <li><a href="#2-include包含">2. include包含</a></li>
            <li><a href="#3-错误处理--ignore_errors-yes">3. 错误处理  ignore_errors: yes</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#八异常处理">八、异常处理</a></li>
    <li><a href="#九ansible-jinja2-模板">九、Ansible Jinja2 模板</a></li>
    <li><a href="#十ansible-roles角色">十、Ansible Roles角色</a>
      <ul>
        <li>
          <ul>
            <li><a href="#1-使用roles创建rsync服务">1. 使用Roles创建Rsync服务</a></li>
            <li><a href="#2-使用rloes创建nfs服务">2. 使用Rloes创建NFS服务</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#十一实战">十一、实战</a></li>
    <li><a href="#十二小技巧">十二、小技巧</a>
      <ul>
        <li>
          <ul>
            <li><a href="#1-取ip地址最后一位">1. 取IP地址最后一位</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
    </div>

    <div class='content  content '>
        <h2 id="一ansible配置文件">一、Ansible配置文件</h2>
<p>[toc]</p>
<h4 id="1-配置文件优先级">1. 配置文件优先级</h4>
<table>
<thead>
<tr>
<th>配置文件名称</th>
<th style="text-align:center">优先级</th>
<th>文件位置</th>
</tr>
</thead>
<tbody>
<tr>
<td>ANSIBLE_CONFIG</td>
<td style="text-align:center">1</td>
<td>定义变量</td>
</tr>
<tr>
<td>ansible.cfg</td>
<td style="text-align:center">2</td>
<td>当前项目目录中</td>
</tr>
<tr>
<td>.ansible.cfg</td>
<td style="text-align:center">3</td>
<td>当前执行用户的家目录</td>
</tr>
<tr>
<td>/etc/ansible/ansible.cfg</td>
<td style="text-align:center">4</td>
<td>默认配置文件位置</td>
</tr>
</tbody>
</table>
<p><strong>验证优先级</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># export ANSIBLE_CONFIG=&#34;/tmp/ansible.cfg&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># touch /tmp/ansible.cfg</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir /project1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /project1/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># touch ansible.cfg</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project2<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible --version</span>
</span></span><span style="display:flex;"><span>ansible 2.8.5
</span></span><span style="display:flex;"><span>config <span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">=</span> /project1/ansible.cfg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager /<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir /project2</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager /<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cd /project2/</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project2<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># touch ansible.cfg</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible --version</span>
</span></span><span style="display:flex;"><span>ansible 2.8.5
</span></span><span style="display:flex;"><span>config <span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">=</span> /project2/ansible.cfg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager tmp<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># touch ~/.ansible.cfg</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager tmp<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible --version</span>
</span></span><span style="display:flex;"><span>ansible 2.8.5
</span></span><span style="display:flex;"><span>config <span style="color:#008080">file</span> <span style="color:#000;font-weight:bold">=</span> /root/.ansible.cfg
</span></span></code></pre></div><h4 id="2-ansible-inventory">2. Ansible inventory</h4>
<p><code>/etc/ansible/hosts</code>主机资产清单文件，用于定义被管理主机的认证信息， 例如<code>ssh</code>登录用户名、密码以及<code>key</code>相关信息。<code>Inventory</code>文件支持以下几种方式：</p>
<ol>
<li>主机支持主机名通配以及正则表达式，例如<code>web[1:3].oldboy.com</code>代表三台主机。</li>
<li>主机支持基于非标准的ssh端口，例如<code>web1.oldboy.com:6666</code>。</li>
<li>主机支持指定变量，可对个别主机的特殊配置，如登陆用户，密码。</li>
<li>主机组支持指定变量<code>[group_name:vars]</code>，同时支持嵌套组<code>[game:children]</code>。</li>
</ol>
<p><strong>配置文件</strong></p>
<p><code>ansible.cfg</code>为<code>ansible</code>的配置，一般放于当前目录下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat ansible.cfg</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>defaults<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">inventory</span>      <span style="color:#000;font-weight:bold">=</span> ./hosts
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># 指定host的的位置，也可以执行ansible的时候通过-i指定hosts位置</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">host_key_checking</span> <span style="color:#000;font-weight:bold">=</span> False
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># ansible通过ssh链接主机时，不会提示*yes ro no* ,默认yes</span>
</span></span></code></pre></div><p><strong>主机清单</strong></p>
<p>基于<code>IP</code>地址+密码的方式。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>webservers<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>172.16.1.7 <span style="color:#008080">ansible_ssh_user</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;root&#39;</span> <span style="color:#008080">ansible_ssh_pass</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;1&#39;</span>
</span></span><span style="display:flex;"><span>172.16.1.8 <span style="color:#008080">ansible_ssh_user</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;root&#39;</span> <span style="color:#008080">ansible_ssh_pass</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;1&#39;</span>
</span></span></code></pre></div><blockquote>
<p>更多参数可参考 <a href="https://ansible-tran.readthedocs.io/en/latest/docs/intro_inventory.html">https://ansible-tran.readthedocs.io/en/latest/docs/intro_inventory.html</a></p>
</blockquote>
<p>基于密钥连接，需要先创建公钥和私钥，并下发公钥至被控端。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ssh-keygen -C manager@qq.com</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ssh-copy-id -i root/.ssh/id_rsa.pub root@172.16.1.7</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ssh-copy-id -i root/.ssh/id_rsa.pub root@172.16.1.8</span>
</span></span></code></pre></div><p><strong>方式一</strong>：定义单个组</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat hosts</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>webservers<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>172.16.1.7
</span></span><span style="display:flex;"><span>172.16.1.8
</span></span></code></pre></div><p><strong>方式二</strong>：将主机分配到不同的组</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>lbservers<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#定义lbservers组</span>
</span></span><span style="display:flex;"><span>172.16.1.5
</span></span><span style="display:flex;"><span>172.16.1.6
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>webservers<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#定义webserver组</span>
</span></span><span style="display:flex;"><span>172.16.1.7
</span></span><span style="display:flex;"><span>172.16.1.8
</span></span></code></pre></div><p><strong>方式三</strong>：定义子组</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>servers:children<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#定义servers组包括两个子组</span>
</span></span><span style="display:flex;"><span>lbservers
</span></span><span style="display:flex;"><span>webserver
</span></span></code></pre></div><p>查看组的主机列表</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers --list-hosts -i hosts </span>
</span></span><span style="display:flex;"><span>  hosts <span style="color:#000;font-weight:bold">(</span>2<span style="color:#000;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>    172.16.1.7
</span></span><span style="display:flex;"><span>    172.16.1.8
</span></span></code></pre></div><h2 id="二ansible-ad-hoc">二、Ansible Ad-Hoc</h2>
<p><strong>执行结果说明</strong></p>
<blockquote>
<p>黄色：对远程节点进行相应修改
绿色：对远程节点不进行相应修改，或者只是对远程节点信息进行查看
红色：操作执行命令有异常
紫色：表示对命令执行发出警告信息（可能存在的问题，给你一下建议）</p>
</blockquote>
<h4 id="1-ansible-ad-hoc语法">1. Ansible Ad-Hoc语法</h4>
<p><img src="https://images.wuennan.cn/Image-1576980610603.png" alt="Image"></p>
<h2 id="三ansilbe常用模块">三、Ansilbe常用模块</h2>
<h4 id="1-模块帮助文档">1. 模块帮助文档</h4>
<p>查看模块列表</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible-doc --list | grep yum</span>
</span></span><span style="display:flex;"><span>yum                                                    Manages packages with the <span style="color:#d14">`</span>yum<span style="color:#a61717;background-color:#e3d2d2">&#39;</span> package manager                                                   
</span></span><span style="display:flex;"><span>yum_repository                                         Add or remove YUM repositories  
</span></span></code></pre></div><p>查看模块详情</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible-doc yum</span>
</span></span></code></pre></div><h4 id="2-command模块">2. command模块</h4>
<p>用于执行命令，默认模块，不支持管道</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -a &#34;ps axu|grep nginx&#34; -i hosts</span>
</span></span></code></pre></div><h4 id="3-shell模块">3. shell模块</h4>
<p>用于执行命令，支持管道</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m shell -a &#34;ps axu|grep nginx&#34; -i hosts</span>
</span></span></code></pre></div><h4 id="4-yum模块">4. yum模块</h4>
<p>常用选项</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> state:
</span></span><span style="display:flex;"><span>present 安装
</span></span><span style="display:flex;"><span>absent 卸载
</span></span><span style="display:flex;"><span>latest 最新
</span></span><span style="display:flex;"><span>enablerepo <span style="color:#998;font-style:italic">#指定使用按个仓库</span>
</span></span><span style="display:flex;"><span>disablerepo <span style="color:#998;font-style:italic">#排除使用哪个仓库</span>
</span></span></code></pre></div><p>安装最新的<code>httpd</code>服务</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m yum -a &#34;name=httpd state=latest disablerepo=webtaticphp&#34; -i hosts</span>
</span></span></code></pre></div><p>移除<code>httpd</code>服务</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m yum -a &#34;name=httpd state=absent disablerepo=webtaticphp&#34; -i hosts</span>
</span></span></code></pre></div><p>安装<code>httpd</code>指定从按个仓库安装</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m yum -a &#34;name=httpd state=latest enablerepo=testing&#34; -i hosts</span>
</span></span></code></pre></div><p>通过<code>URL</code>方式进行安装</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m yum -a &#34;name=https://mirrors.aliyun.com/zabbix/zabbix/3.0/rhel/7/x86_64/zabbix-agent-3.0.0-1.el7.x86_64.rpm state=present disablerepo=webtatic-php&#34; -i hosts</span>
</span></span></code></pre></div><p>安装本地软件包(软件包必须在被控端主机)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m yum -a &#34;name=/root/zabbix-agent-4.0.0-2.el7.x86_64.rpm state=present disablerepo=webtatic-php&#34; -i hosts</span>
</span></span></code></pre></div><p> </p>
<h4 id="5-copy模块">5. copy模块</h4>
<p>常用选项</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>src <span style="color:#998;font-style:italic">#本地路径,可以是相对,可以是绝对</span>
</span></span><span style="display:flex;"><span>dest <span style="color:#998;font-style:italic">#目标位置</span>
</span></span><span style="display:flex;"><span>owner <span style="color:#998;font-style:italic">#属主</span>
</span></span><span style="display:flex;"><span>group <span style="color:#998;font-style:italic">#属组</span>
</span></span><span style="display:flex;"><span>mode <span style="color:#998;font-style:italic">#权限</span>
</span></span><span style="display:flex;"><span>backup <span style="color:#998;font-style:italic">#备份</span>
</span></span></code></pre></div><p>将本机的ansible.oldxu.com.conf拷贝到被控制端，并将属组和属主设置为root，权限为644</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m copy -a &#34;src=./file/ansible.oldxu.com.conf dest=/etc/nginx/conf.d/ansible.oldxu.com.conf owner=root group=root mode=644&#34; -i hosts</span>
</span></span></code></pre></div><p>拷贝文件到远程主机，原来的文件不覆盖，将其重命名（系统通过backup选项自动实现）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m copy -a &#34;src=./file/ansible.oldxu.com.conf dest=/etc/nginx/conf.d/ansible.oldxu.com.conf owner=root group=root mode=644 backup=yes&#34; -i hosts</span>
</span></span></code></pre></div><p> </p>
<h4 id="6--service--systemd模块">6.  service | systemd模块</h4>
<p>常用语法</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>state
</span></span><span style="display:flex;"><span>started <span style="color:#998;font-style:italic">#启动</span>
</span></span><span style="display:flex;"><span>stopped <span style="color:#998;font-style:italic">#停止</span>
</span></span><span style="display:flex;"><span>restarted <span style="color:#998;font-style:italic">#重启</span>
</span></span><span style="display:flex;"><span>reloaded <span style="color:#998;font-style:italic">#重载</span>
</span></span><span style="display:flex;"><span>enabled <span style="color:#998;font-style:italic">#是否开机自启（yes or no）</span>
</span></span></code></pre></div><p>重启<code>nginx</code>，并加入到开机自启</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m systemd -a &#34;name=nginx state=restarted enabled=yes&#34; -i hosts</span>
</span></span></code></pre></div><p> </p>
<h4 id="7-file模块">7. file模块</h4>
<p>常用选项</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>path <span style="color:#998;font-style:italic">#路径</span>
</span></span><span style="display:flex;"><span>state
</span></span><span style="display:flex;"><span>    touch <span style="color:#998;font-style:italic">#创建文件</span>
</span></span><span style="display:flex;"><span>    directory <span style="color:#998;font-style:italic">#创建目录</span>
</span></span><span style="display:flex;"><span>owne  <span style="color:#998;font-style:italic">#属主</span>
</span></span><span style="display:flex;"><span>group <span style="color:#998;font-style:italic">#属组</span>
</span></span><span style="display:flex;"><span>mode <span style="color:#998;font-style:italic">#权限</span>
</span></span></code></pre></div><p>创建 <code>/code/ansible</code>，准备站点</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m file -a &#34;path=/code/ansible state=directory mode=755 owner=www  group=www&#34;  -i hosts</span>
</span></span></code></pre></div><p>准备站点代码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m copy -a &#34;src=./file/index.html dest=/code/ansible/index.html owner=www group=www mode=644&#34; -i hosts</span>
</span></span></code></pre></div><p> </p>
<h4 id="8-group模块">8. group模块</h4>
<p>创建www用户组，gid为666</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m group -a &#34;name=www gid=666 state=present&#34; -i hosts</span>
</span></span></code></pre></div><p> </p>
<h4 id="9-user模块">9. user模块</h4>
<p>常用选项</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>name <span style="color:#998;font-style:italic">#名称</span>
</span></span><span style="display:flex;"><span>uid <span style="color:#998;font-style:italic">#uid</span>
</span></span><span style="display:flex;"><span>group  <span style="color:#998;font-style:italic">#组名或gid</span>
</span></span><span style="display:flex;"><span>create_home  <span style="color:#998;font-style:italic">#是否创建家目录</span>
</span></span><span style="display:flex;"><span>system <span style="color:#998;font-style:italic">#是否作为系统组</span>
</span></span><span style="display:flex;"><span> shell <span style="color:#998;font-style:italic">#指定登录shell</span>
</span></span><span style="display:flex;"><span>state
</span></span><span style="display:flex;"><span>    present <span style="color:#998;font-style:italic">#创建目录</span>
</span></span><span style="display:flex;"><span>    absent <span style="color:#998;font-style:italic">#删除用户，不包括家目录</span>
</span></span><span style="display:flex;"><span>remove  <span style="color:#998;font-style:italic">#删除用户的所有信息，包括家目录等</span>
</span></span><span style="display:flex;"><span>groups <span style="color:#998;font-style:italic">#附加组</span>
</span></span><span style="display:flex;"><span>append
</span></span><span style="display:flex;"><span>password
</span></span></code></pre></div><p>创建程序使用的用户www，uid和gid均为666，shell为/sbin/nologin，不创建家目录。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m user -a &#34;name=www uid=666 group=666 create_home=no shell=/sbin/nologin state=present&#34; -i hosts</span>
</span></span></code></pre></div><p>创建正常用户oldxu，gid和uid均为1000，shell为/bin/bash，家目录为/home/oldxu</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m user -a &#34;name=oldxu&#34; -i hosts</span>
</span></span></code></pre></div><p>移除<code>oldxu</code>用户,并删除家目录所有内容.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m user -a &#34;name=oldxu state=absent remove=yes&#34; -i hosts</span>
</span></span></code></pre></div><p>创建 <code>other</code>用户，有两个附加组<code>root bin</code>，创建家目录,指定登录<code>shell</code>，设定密码<code>123</code>
生成一个密文密码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible all -i localhost, -m debug -a &#34;msg={{ &#39;123&#39; | password_hash(&#39;sha512&#39;, &#39;mysecretsalt&#39;) }}&#34;</span>
</span></span></code></pre></div><p>创建用户并指定密码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m user -a &#39;name=other groups=&#39;root,bin&#39; create_home=yes shell=/bin/bash password=&#34;$6$mysecretsalt$gIIYs0Xgc7sSQkH.zKaz8/AfaMomYzR1QZYtccwmJcUt8VpLq4D055UCCX4MlwgePOP80ZRwhppvBF72RIAVi/&#34;&#39; -i hosts</span>
</span></span></code></pre></div><h4 id="10-mount模块">10. mount模块</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#998;font-style:italic">#用管理端操作被控端,让被控端挂载nfs存储数据</span>
</span></span><span style="display:flex;"><span>present <span style="color:#998;font-style:italic">#写入/etc/fstab</span>
</span></span><span style="display:flex;"><span>absent <span style="color:#998;font-style:italic">#卸载/etc/fstab</span>
</span></span><span style="display:flex;"><span>mounted <span style="color:#998;font-style:italic">#临时挂载</span>
</span></span><span style="display:flex;"><span>unmounted <span style="color:#998;font-style:italic">#卸载当前挂载</span>
</span></span></code></pre></div><ul>
<li>挂载nfs文件，挂载过程中,如果目录不存在,则会创建该目录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m mount -a &#34;src=172.16.1.31:/data/zrlog path=/test_zrlog fstype=nfs opts=defaults state=mounted&#34; -i hosts</span>
</span></span></code></pre></div><ul>
<li>卸载</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m mount -a &#34;src=172.16.1.31:/data/zrlog path=/test_zrlog fstype=nfs opts=defaults state=unmounted&#34; -i hosts</span>
</span></span></code></pre></div><p> </p>
<h4 id="11-cron模块">11. cron模块</h4>
<ul>
<li>常用选项</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minute <span style="color:#998;font-style:italic">#分</span>
</span></span><span style="display:flex;"><span>hour <span style="color:#998;font-style:italic">#时</span>
</span></span><span style="display:flex;"><span>month <span style="color:#998;font-style:italic">#月</span>
</span></span><span style="display:flex;"><span>week <span style="color:#998;font-style:italic">#周</span>
</span></span><span style="display:flex;"><span>job <span style="color:#998;font-style:italic">#任务</span>
</span></span></code></pre></div><ul>
<li>每天2:00执行任务</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m cron -a &#39;name=test_job minute=00 hour=02 job=&#34;/bin/bash /server/scripts/client_to_data_server.sh &amp;&gt;/dev/null&#34;&#39; -i hosts</span>
</span></span></code></pre></div><ul>
<li>每分钟都执行任务</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m cron -a &#39;name=test job=&#34;/bin/bash /server/scripts/test.sh &amp;&gt;/dev/null&#34;&#39; -i hosts</span>
</span></span></code></pre></div><ul>
<li>取消定时任务</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m cron -a &#39;name=test job=&#34;/bin/bash/server/scripts/test.sh &amp;&gt;/dev/null&#34; state=absent&#39; -i hosts</span>
</span></span></code></pre></div><h4 id="12-firewalld模块">12. firewalld模块</h4>
<ul>
<li>开启firewalld服务</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m systemd -a &#34;name=firewalld state=started&#34; -i hosts</span>
</span></span></code></pre></div><ul>
<li>放行http服务</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m firewalld -a service=http state=enabled&#34; -i hosts</span>
</span></span></code></pre></div><ul>
<li>放行端口</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m firewalld -a port=9999/tcp state=enabled&#34; -i hosts</span>
</span></span></code></pre></div><ul>
<li>针对source来源</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m firewalld -a &#34;source=172.16.1.0/24 state=enabled permanent=no zone=public&#34; -i hosts </span>
</span></span></code></pre></div><ul>
<li>富规则</li>
<li>默认public区域对外开放所有人能通过ssh服务连接，但拒绝172.16.1.0/24网段通过ssh连接服务器</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m firewalld  -a &#39;rich_rule=&#34;rule family=ipv4 source address=172.16.1.0/24 service name=ssh drop&#34; zone=public permanent=no immediate=yes state=enabled&#39; -i hosts </span>
</span></span></code></pre></div><h4 id="13-selinux模块">13. selinux模块</h4>
<ul>
<li>关闭selinux</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m selinux -a &#34;state=disabled&#34; -i hosts</span>
</span></span></code></pre></div><h4 id="14-get_url模块">14. get_url模块</h4>
<ul>
<li>从阿里云下载Centos-7.repo到/root目录，权限设置为644</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m get_url -a &#34;url=http://mirrors.aliyun.com/repo/Centos-7.repo dest=/root mode=644&#34; -i hosts</span>
</span></span></code></pre></div><h4 id="15-yum_repository模块">15. yum_repository模块</h4>
<ul>
<li>添加一个本地yum仓库</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m yum_repository -a &#39;name=&#34;local-cdrom&#34; description=&#34;This is a cdrom&#34; baseurl=file:///mnt gpgcheck=0 enabled=yes&#39; -i hosts </span>
</span></span></code></pre></div><ul>
<li>移除本地yum仓库</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible webservers -m yum_repository -a &#39;name=&#34;local-cdrom&#34; state=absent&#39; -i hosts</span>
</span></span></code></pre></div><h2 id="四ansible-playbook">四、Ansible Playbook</h2>
<h4 id="1-playbook简介">1. Playbook简介</h4>
<p><strong>Playbook优势</strong></p>
<ol>
<li>功能比ad-hoc更全。</li>
<li>能很好的控制先后执行顺序, 以及依赖关系。</li>
<li>语法展现更加的直观。</li>
<li><code>ad-hoc</code>无法持久使用，<code>playbook</code>可以持久使用。</li>
</ol>
<p><code>Playbook</code>使用的是<code>yaml</code>的语法，需要遵循以下规范：</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>缩进</td>
<td>YAML使用固定的缩进风格表示层级结构,每个缩进由两个空格组成, 不能使用tabs</td>
</tr>
<tr>
<td>冒号</td>
<td>以冒号结尾的除外，其他所有冒号后面所有必须有空格</td>
</tr>
<tr>
<td>短横线</td>
<td>表示列表项，使用一个短横杠加一个空格。多个项使用同样的缩进级别作为同一列表。</td>
</tr>
</tbody>
</table>
<h4 id="2-使用ansible安装并配置nfs服务">2. 使用ansible安装并配置nfs服务</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#172.16.1.31   nfs</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#172.16.1.7    clinet</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#172.16.1.8    clinet</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#1.新增一台nfs服务器</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat hosts </span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>nfsservers<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>172.16.1.31
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>webservers<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>172.16.1.7
</span></span><span style="display:flex;"><span>172.16.1.8
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.31</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#2.测试三台主机是否通</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible all -m ping -i hosts</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#3.编写一个nfs-server的yml</span>
</span></span><span style="display:flex;"><span>	1.安装nfs			yum
</span></span><span style="display:flex;"><span>	2.配置nfs			copy
</span></span><span style="display:flex;"><span>	3.初始化环境		
</span></span><span style="display:flex;"><span>		用户			group  user
</span></span><span style="display:flex;"><span>		目录			file
</span></span><span style="display:flex;"><span>		授权			file
</span></span><span style="display:flex;"><span>	4.启动服务		   systemd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat nfs_server.yml </span>
</span></span><span style="display:flex;"><span>- hosts: nfsservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Installed NFS Server
</span></span><span style="display:flex;"><span>      yum:
</span></span><span style="display:flex;"><span>        name: nfs-utils
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Configure NFS Server
</span></span><span style="display:flex;"><span>      copy:
</span></span><span style="display:flex;"><span>        src: ./file/exports.j2 
</span></span><span style="display:flex;"><span>        dest: /etc/exports
</span></span><span style="display:flex;"><span>        owner: root
</span></span><span style="display:flex;"><span>        group: root
</span></span><span style="display:flex;"><span>        mode: <span style="color:#099">0644</span>
</span></span><span style="display:flex;"><span>        backup: yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Create NFS Group www
</span></span><span style="display:flex;"><span>      group:
</span></span><span style="display:flex;"><span>        name: www
</span></span><span style="display:flex;"><span>        gid: <span style="color:#099">666</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Create NFS User www
</span></span><span style="display:flex;"><span>      user:
</span></span><span style="display:flex;"><span>        name: www
</span></span><span style="display:flex;"><span>        group: www
</span></span><span style="display:flex;"><span>        uid: <span style="color:#099">666</span>
</span></span><span style="display:flex;"><span>        create_home: no
</span></span><span style="display:flex;"><span>        shell: /sbin/nologin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Create NFS Share Directory
</span></span><span style="display:flex;"><span>      file:
</span></span><span style="display:flex;"><span>        path: /ansible_data
</span></span><span style="display:flex;"><span>        state: directory
</span></span><span style="display:flex;"><span>        owner: www
</span></span><span style="display:flex;"><span>        group: www
</span></span><span style="display:flex;"><span>        mode: <span style="color:#099">0755</span>
</span></span><span style="display:flex;"><span>        recurse: yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Systemd NFS Server 
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: nfs
</span></span><span style="display:flex;"><span>        state: restarted
</span></span><span style="display:flex;"><span>        enabled: yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#4.编写一个nfs-clinet的yml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat nfs_client.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Mount NFS Server share directory
</span></span><span style="display:flex;"><span>      mount:
</span></span><span style="display:flex;"><span>        src: 172.16.1.31:/ansible_data
</span></span><span style="display:flex;"><span>        path: /mnt
</span></span><span style="display:flex;"><span>        fstype: nfs
</span></span><span style="display:flex;"><span>        opts: defaults
</span></span><span style="display:flex;"><span>        state: mounted
</span></span></code></pre></div><h4 id="3-使用ansible安装并配置nginx服务">3. 使用ansible安装并配置nginx服务</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>1.安装		yum
</span></span><span style="display:flex;"><span>2.配置		copy
</span></span><span style="display:flex;"><span>3.启动		systmd
</span></span><span style="display:flex;"><span>handlers
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat nginx.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Installed Nginx Server
</span></span><span style="display:flex;"><span>      yum:
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Configure Nginx Server
</span></span><span style="display:flex;"><span>      copy:
</span></span><span style="display:flex;"><span>        src: ./file/nginx.conf.j2
</span></span><span style="display:flex;"><span>        dest: /etc/nginx/nginx.conf
</span></span><span style="display:flex;"><span>        owner: root
</span></span><span style="display:flex;"><span>        group: root
</span></span><span style="display:flex;"><span>        mode: <span style="color:#099">0644</span>
</span></span><span style="display:flex;"><span>        backup: yes
</span></span><span style="display:flex;"><span>      notify: Restart Nginx Server
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>    - name: Systmd nginx Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>        enabled: yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  handlers:
</span></span><span style="display:flex;"><span>    - name: Restart Nginx Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: restarted
</span></span></code></pre></div><h4 id="4-使用ansibleplaybook方式构建lap架构">4. 使用AnsiblePlaybook方式构建LAP架构</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat hosts </span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>nfsservers<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>172.16.1.31
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>backupservers<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>172.16.1.41
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>web:children<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>nfsservers
</span></span><span style="display:flex;"><span>backupservers
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>webservers<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>172.16.1.7
</span></span><span style="display:flex;"><span>172.16.1.8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#具体配置</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat lamp.yml </span>
</span></span><span style="display:flex;"><span>- hosts: web
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Installed Httpd Server
</span></span><span style="display:flex;"><span>      yum: 
</span></span><span style="display:flex;"><span>        name: httpd
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Installed PHP Server
</span></span><span style="display:flex;"><span>      yum: 
</span></span><span style="display:flex;"><span>        name: php
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Configure Httpd WebSite
</span></span><span style="display:flex;"><span>      get_url:
</span></span><span style="display:flex;"><span>        url: http://fj.xuliangwei.com/public/index.php
</span></span><span style="display:flex;"><span>        dest: /var/www/html/index.php
</span></span><span style="display:flex;"><span>        mode: <span style="color:#099">0644</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Systemd Httpd Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: httpd
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Systemd Firewalld Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: firewalld
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Configure Firewalld Rule
</span></span><span style="display:flex;"><span>      firewalld:
</span></span><span style="display:flex;"><span>        service: http
</span></span><span style="display:flex;"><span>        state: enabled
</span></span></code></pre></div><p><img src="https://images.wuennan.cn/1570680036415.png" alt="1570680036415"></p>
<h2 id="五ansible-varialbes">五、Ansible varialbes</h2>
<h4 id="1-在playbook中定义变量">1. 在Playbook中定义变量</h4>
<ol>
<li><strong>vars  关键字</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f2.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  vars:
</span></span><span style="display:flex;"><span>    - file_name: playbook_vars
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Create New File
</span></span><span style="display:flex;"><span>      file:
</span></span><span style="display:flex;"><span>        path: /tmp/<span style="color:#000;font-weight:bold">{{</span> file_name <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>        state: touch
</span></span></code></pre></div><ol start="2">
<li>
<p><strong>vars_file</strong></p>
<p>属于一种共享的方式</p>
</li>
</ol>
<p><img src="https://images.wuennan.cn/1570755668515.png" alt="1570755668515"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat vars_file.yml </span>
</span></span><span style="display:flex;"><span>web_packages: httpd
</span></span><span style="display:flex;"><span>ftp_packages: vsftpd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f2.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  vars:
</span></span><span style="display:flex;"><span>    - file_name: playbook_vars
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#998;font-style:italic">#调用共享vars_file文件,只不过刚好文件名叫vars_file</span>
</span></span><span style="display:flex;"><span>  vars_files: ./vars_file.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Create New File
</span></span><span style="display:flex;"><span>      file:
</span></span><span style="display:flex;"><span>        path: /tmp/<span style="color:#000;font-weight:bold">{{</span> file_name <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>        state: touch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Installed Packages <span style="color:#000;font-weight:bold">{{</span> web_packages <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>      yum:
</span></span><span style="display:flex;"><span>        name: <span style="color:#d14">&#34;{{ web_packages }}&#34;</span>
</span></span><span style="display:flex;"><span>        state: present
</span></span></code></pre></div><h4 id="2-在inventory主机清单中定义">2. 在inventory主机清单中定义</h4>
<ul>
<li>1.清单文件中直接定义  hosts文件定义&ndash;</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>webservers<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>172.16.1.7
</span></span><span style="display:flex;"><span>172.16.1.8 
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>webservers:vars<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">file_name</span><span style="color:#000;font-weight:bold">=</span>hostsfile_group_vars
</span></span></code></pre></div><ul>
<li>2.创建hosts_vars  group_vars 目录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir hosts_vars	#单个主机</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># mkdir group_vars	#主机组</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#1.单个主机定义和使用方式 (host_vars能分别对不同的主机定义变量)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat host_vars/172.16.1.7 </span>
</span></span><span style="display:flex;"><span>host_vars_name: 172.16.1.7
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat host_vars/172.16.1.8 </span>
</span></span><span style="display:flex;"><span>host_vars_name: 172.16.1.8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f4.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Create New File
</span></span><span style="display:flex;"><span>      file:
</span></span><span style="display:flex;"><span>        path: /opt/<span style="color:#000;font-weight:bold">{{</span> host_vars_name <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>        state: touch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#2.针对主机组定义的方式 </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#给指定的webserver组设定变量.其他组主机无法使用该变量</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat group_vars/webservers </span>
</span></span><span style="display:flex;"><span>group_host_vars: webservers
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f5.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Create New File <span style="color:#000;font-weight:bold">{{</span> group_host_vars <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>      file:
</span></span><span style="display:flex;"><span>        path:  /opt/<span style="color:#000;font-weight:bold">{{</span> group_host_vars <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>        state: touch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#3.针对主机组定义的方式  (给所有的主机和主机组设定变量)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat group_vars/all </span>
</span></span><span style="display:flex;"><span>group_host_vars: all
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f5.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Create New File <span style="color:#000;font-weight:bold">{{</span> group_host_vars <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>      file:
</span></span><span style="display:flex;"><span>        path:  /opt/<span style="color:#000;font-weight:bold">{{</span> group_host_vars <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>        state: touch
</span></span></code></pre></div><h4 id="3-通过外置传参定义变量">3. 通过外置传参定义变量</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible-playbook -i hosts f6.yml  -e &#34;web_vars=123&#34;</span>
</span></span></code></pre></div><h4 id="4-变量优先级">4. 变量优先级</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>6.定义相同的变量不同的值，来测试变量的优先级。操作步骤如下   file_name:
</span></span><span style="display:flex;"><span>  1）在plabook中定义vars变量
</span></span><span style="display:flex;"><span>  2）在playbook中定义vars_files变量
</span></span><span style="display:flex;"><span>  3）在inventory主机定义变量
</span></span><span style="display:flex;"><span>  4）在inventory主机组定义变量
</span></span><span style="display:flex;"><span>  5）在host_vars中定义变量
</span></span><span style="display:flex;"><span>  6）在group_vars中定义变量  组      all组
</span></span><span style="display:flex;"><span>  7）通过执行命令传递变量
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>优先级测试:
</span></span><span style="display:flex;"><span>外置传入参数优先级最高 ---&gt; playbook <span style="color:#000;font-weight:bold">(</span> vars_files<span style="color:#000;font-weight:bold">(</span>共享<span style="color:#000;font-weight:bold">)</span>---&gt;vars<span style="color:#000;font-weight:bold">(</span>私有<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">)</span>  
</span></span><span style="display:flex;"><span>---&gt; host_vars  --&gt; group_vars/group_name ---&gt; group_vars/all
</span></span></code></pre></div><h4 id="5-变量注册register">5. 变量注册register</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f8.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># System_Status=$(netstat -lntp)</span>
</span></span><span style="display:flex;"><span>    - name: Get Network Status
</span></span><span style="display:flex;"><span>      shell: netstat -lntp | grep <span style="color:#d14">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>      register: System_Status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic"># echo &#34;$System_Status&#34;</span>
</span></span><span style="display:flex;"><span>    - name: Debug output Variables
</span></span><span style="display:flex;"><span>      debug:
</span></span><span style="display:flex;"><span>        msg: <span style="color:#d14">&#34;{{ System_Status.stdout_lines }}&#34;</span>
</span></span></code></pre></div><h4 id="6-facts变量">6. facts变量</h4>
<p><img src="https://images.wuennan.cn/1570768637521.png" alt="1570768637521"></p>
<p>查看facts变量</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible localhost -m setup -i hosts</span>
</span></span></code></pre></div><ol>
<li>
<p>根据主机的配置信息,生成不同的配置文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat ./file/zabbix_agent.conf.j2 </span>
</span></span><span style="display:flex;"><span><span style="color:#008080">Server</span><span style="color:#000;font-weight:bold">={{</span> zabbix_server_ip <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">ServerActive</span><span style="color:#000;font-weight:bold">={{</span> zabbix_server_ip <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">Hostname</span><span style="color:#000;font-weight:bold">={{</span> ansible_hostname <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f11.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  vars:
</span></span><span style="display:flex;"><span>    - zabbix_server_ip: 172.16.1.61
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Configure zabbix-agent.conf
</span></span><span style="display:flex;"><span>      template:
</span></span><span style="display:flex;"><span>        src: ./file/zabbix_agent.conf.j2
</span></span><span style="display:flex;"><span>        dest: /tmp/zabbix-agent.conf
</span></span></code></pre></div></li>
<li>
<p>根据主机的内存生成不同的配置文件,memcached</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f12.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Installed Memcached Server
</span></span><span style="display:flex;"><span>      yum:
</span></span><span style="display:flex;"><span>        name: memcached
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Configure Memcached Server
</span></span><span style="display:flex;"><span>      template:
</span></span><span style="display:flex;"><span>        src: ./file/memcached.j2
</span></span><span style="display:flex;"><span>        dest: /etc/sysconfig/memcached
</span></span><span style="display:flex;"><span>      notify: Restart Memcached Server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: System Memcached Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: memcached
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>        enabled: yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  handlers:
</span></span><span style="display:flex;"><span>    - name: Restart Memcached Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: memcached
</span></span><span style="display:flex;"><span>        state: restarted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat file/memcached.j2 </span>
</span></span><span style="display:flex;"><span><span style="color:#008080">PORT</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;11211&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">USER</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;memcached&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">MAXCONN</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;1024&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">CACHESIZE</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;{{ ansible_memtotal_mb //2 }}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#008080">OPTIONS</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;&#34;</span>
</span></span></code></pre></div></li>
<li>
<p>给web主机命名，名称不能相同</p>
<p>这里只是生成不同的主机名</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#1. 通过RANDOM生成不同的主机名</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f13.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: RANDOM
</span></span><span style="display:flex;"><span>      shell:  <span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;</span><span style="color:#008080">$RANDOM</span><span style="color:#d14">&#34;</span>
</span></span><span style="display:flex;"><span>      register: System_SJ
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Debug 
</span></span><span style="display:flex;"><span>      debug:
</span></span><span style="display:flex;"><span>        msg: <span style="color:#d14">&#34;web_{{ System_SJ.stdout }}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#2. 提取facts变量中的IP地址   mac地址  UUID 等信息  唯一即可</span>
</span></span><span style="display:flex;"><span>	ansible_default_ipv4.address
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f14.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Debug 
</span></span><span style="display:flex;"><span>      debug:
</span></span><span style="display:flex;"><span>        msg: <span style="color:#d14">&#34;web_{{ ansible_default_ipv4.address }}&#34;</span>
</span></span></code></pre></div></li>
</ol>
<h2 id="六ansible-流程控制">六、Ansible 流程控制</h2>
<h4 id="1-判断语句">1. 判断语句</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#根据不同的系统,安装不同的服务</span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: CentOS Installed Httpd Server
</span></span><span style="display:flex;"><span>      yum:
</span></span><span style="display:flex;"><span>        name: httpd
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>      when: <span style="color:#000;font-weight:bold">(</span> <span style="color:#008080">ansible_distribution</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;CentOS&#34;</span> <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Ubuntu Installed Httpd Server
</span></span><span style="display:flex;"><span>      yum:
</span></span><span style="display:flex;"><span>        name: httpd2
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>      when: <span style="color:#000;font-weight:bold">(</span> <span style="color:#008080">ansible_distribution</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;Ubuntu&#34;</span> <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f16.yml </span>
</span></span><span style="display:flex;"><span>- hosts: all
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>  - name: Add Nginx Yum Repository
</span></span><span style="display:flex;"><span>    yum_repository:
</span></span><span style="display:flex;"><span>      name: nginx
</span></span><span style="display:flex;"><span>      description: Nginx Repository
</span></span><span style="display:flex;"><span>      baseurl: http://nginx.org/packages/centos/7/<span style="color:#008080">$basearch</span>/
</span></span><span style="display:flex;"><span>    when: <span style="color:#000;font-weight:bold">(</span> ansible_hostname is match <span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;web*&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f17.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Check Httpd Server
</span></span><span style="display:flex;"><span>      command: systemctl is-active httpd
</span></span><span style="display:flex;"><span>      register: Check_Httpd
</span></span><span style="display:flex;"><span>      ignore_errors: yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">#判断Check_Httpd.rc是否等于0,如果为0则执行任务,否则不执行</span>
</span></span><span style="display:flex;"><span>    - name: Restart Httpd Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: httpd
</span></span><span style="display:flex;"><span>        state: restarted
</span></span><span style="display:flex;"><span>      when: <span style="color:#000;font-weight:bold">(</span> Check_Httpd.rc <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h4 id="2-循环语句">2. 循环语句</h4>
<p>标准循环</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#一次启动多个服务</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f18.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Systemd Nginx Status
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: <span style="color:#d14">&#34;{{ item }}&#34;</span>    <span style="color:#998;font-style:italic">#调用的变量也不变,也是固定</span>
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#998;font-style:italic">#固定的语法格式</span>
</span></span><span style="display:flex;"><span>      with_items:
</span></span><span style="display:flex;"><span>        - nginx
</span></span><span style="display:flex;"><span>        - php-fpm
</span></span></code></pre></div><p>字典循环</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#一次拷贝多个文件</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f19.yml</span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Configure nginx.conf
</span></span><span style="display:flex;"><span>      copy:
</span></span><span style="display:flex;"><span>        src: <span style="color:#d14">&#39;{{ item.src }}&#39;</span>
</span></span><span style="display:flex;"><span>        dest: <span style="color:#d14">&#39;{{ item.dest }}&#39;</span>
</span></span><span style="display:flex;"><span>        mode: <span style="color:#d14">&#39;{{ item.mode }}&#39;</span>
</span></span><span style="display:flex;"><span>      with_items:
</span></span><span style="display:flex;"><span>        - <span style="color:#000;font-weight:bold">{</span> src: ./file/nginx.conf.j2, dest: /etc/nginx/nginx.conf, mode: <span style="color:#d14">&#39;0644&#39;</span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#000;font-weight:bold">{</span> src: ./file/kold.oldxu.com.conf.j2, dest: /etc/nginx/conf.d/kold.oldxu.com.conf, mode: <span style="color:#d14">&#39;0600&#39;</span> <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>变量循环</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: ensure a list of packages installed
</span></span><span style="display:flex;"><span>      yum: <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">={{</span> packages <span style="color:#000;font-weight:bold">}}</span> <span style="color:#008080">state</span><span style="color:#000;font-weight:bold">=</span>present
</span></span><span style="display:flex;"><span>      vars:
</span></span><span style="display:flex;"><span>        packages:
</span></span><span style="display:flex;"><span>          - httpd
</span></span><span style="display:flex;"><span>          - httpd-tools
</span></span></code></pre></div><h4 id="3-触发器handlers">3. 触发器handlers</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager project1<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f22.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Installed Nginx and PHP Packages
</span></span><span style="display:flex;"><span>      yum:
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Configure nginx.conf 
</span></span><span style="display:flex;"><span>      template:
</span></span><span style="display:flex;"><span>        src: ./file/nginx.conf.j2
</span></span><span style="display:flex;"><span>        dest: /etc/nginx/nginx.conf
</span></span><span style="display:flex;"><span>      <span style="color:#998;font-style:italic">#监控--&gt;changed状态--&gt;通知--&gt;handlers---&gt;name--&gt;Restart Nginx Server</span>
</span></span><span style="display:flex;"><span>      notify: Restart Nginx Server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Systemd Nginx Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>        enabled: yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#当nginx或php配置文件发生变更才会触发此操作</span>
</span></span><span style="display:flex;"><span>  handlers:
</span></span><span style="display:flex;"><span>    - name: Restart Nginx Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: restarted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#3.handlers注意事项</span>
</span></span><span style="display:flex;"><span>	1.无论多少个task通知了相同的handlers，handlers仅会在所有tasks结束后运行一次。
</span></span><span style="display:flex;"><span>	2.只有task发生改变了才会通知handlers，没有改变则不会触发handlers.
</span></span><span style="display:flex;"><span>	3.不能使用handlers替代tasks、因为handlers是一个特殊的tasks。
</span></span></code></pre></div><h2 id="七ansible调试">七、Ansible调试</h2>
<h4 id="1-tag标签">1. tag标签</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager tasks<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat task_nfs.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#对一个任务打多个标签</span>
</span></span><span style="display:flex;"><span>    - name: Install Nfs Server
</span></span><span style="display:flex;"><span>      yum: 
</span></span><span style="display:flex;"><span>        name: nfs-utils
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>      tags:
</span></span><span style="display:flex;"><span>        - install_nfs
</span></span><span style="display:flex;"><span>        - install_nfs-server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#对一个任务打一个标签</span>
</span></span><span style="display:flex;"><span>    - name: Service Nfs Server
</span></span><span style="display:flex;"><span>      service:
</span></span><span style="display:flex;"><span>        name: nfs-server 
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>        enabled: yes
</span></span><span style="display:flex;"><span>      tags: start_nfs-server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ansible-playbook -i ../hosts  task_nfs.yml  -t start_nfs-server123
</span></span><span style="display:flex;"><span>ansible-playbook -i ../hosts  task_nfs.yml  --skip-tags install_nfs-server
</span></span></code></pre></div><h4 id="2-include包含">2. include包含</h4>
<p>include用来动态的包含tasks任务列表，<code>include_tasks新版/include老版</code></p>
<p><img src="https://images.wuennan.cn/image-20191222160208539.png" alt="image-20191222160208539">include调用任务方式</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#主入口文件</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@mha ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat main.yml</span>
</span></span><span style="display:flex;"><span>- hosts: all
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - include_tasks: f20.yml
</span></span><span style="display:flex;"><span>    - include_tasks: f21.yml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#f20.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@mha ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f20.yml</span>
</span></span><span style="display:flex;"><span>- name: create file1
</span></span><span style="display:flex;"><span>  command: touch file1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#21.yml</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@mha ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f21.yml</span>
</span></span><span style="display:flex;"><span>- name: create file2
</span></span><span style="display:flex;"><span>  command: touch file2
</span></span></code></pre></div><h4 id="3-错误处理--ignore_errors-yes">3. 错误处理  ignore_errors: yes</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>默认Playbook会检查命令和模块的返回状态，如遇到错误就中断playbook的执行
</span></span><span style="display:flex;"><span>加入参数: ignore_errors: yes 忽略错误
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat f9.yml</span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: all
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Ignore False
</span></span><span style="display:flex;"><span>      command: /bin/false
</span></span><span style="display:flex;"><span>      ignore_errors: yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: touch new file
</span></span><span style="display:flex;"><span>      file: <span style="color:#008080">path</span><span style="color:#000;font-weight:bold">=</span>/tmp/bgx_ignore <span style="color:#008080">state</span><span style="color:#000;font-weight:bold">=</span>touch
</span></span></code></pre></div><h2 id="八异常处理">八、异常处理</h2>
<ol>
<li>
<p>每次状态都是<code>changed</code>,纵使没有修改过被控端</p>
<p><code>changed_when</code>改变输出状态</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#Check_Redis_Status=$(netstat -lntp | grep redis) </span>
</span></span><span style="display:flex;"><span>    - name: Check Redis Status
</span></span><span style="display:flex;"><span>      shell: netstat -lntp | grep redis
</span></span><span style="display:flex;"><span>      register: Check_Redis_Status
</span></span><span style="display:flex;"><span>      changed_when: <span style="color:#0086b3">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#echo ${Check_Redis_Status}</span>
</span></span><span style="display:flex;"><span>    - name: Debug Check_Redis Variables
</span></span><span style="display:flex;"><span>      debug:
</span></span><span style="display:flex;"><span>        msg: <span style="color:#d14">&#34;Redis Status: {{ Check_Redis_Status.stdout_lines }}&#34;</span> 
</span></span></code></pre></div></li>
<li>
<p>nginx推送配置文件后,没有任何的检查功能</p>
<p>方案一：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager tasks<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat task_nginx.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#安装nginx</span>
</span></span><span style="display:flex;"><span>    - name: Installed nginx Server
</span></span><span style="display:flex;"><span>      yum: 
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#配置nginx</span>
</span></span><span style="display:flex;"><span>    - name: Configure nginx Server
</span></span><span style="display:flex;"><span>      template:
</span></span><span style="display:flex;"><span>        src: ./file/nginx.conf.j2
</span></span><span style="display:flex;"><span>        dest: /etc/nginx/nginx.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#检查nginx (Check_Nginx_Status=$(nginx -t))</span>
</span></span><span style="display:flex;"><span>    - name: Check Nginx Configure File
</span></span><span style="display:flex;"><span>      shell: nginx -t
</span></span><span style="display:flex;"><span>      register: Check_Nginx_Status
</span></span><span style="display:flex;"><span>      ignore_errors: yes
</span></span><span style="display:flex;"><span>      changed_when: <span style="color:#0086b3">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#启动Nginx</span>
</span></span><span style="display:flex;"><span>    - name: Systemd Nginx Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>        enabled: yes 
</span></span><span style="display:flex;"><span>      when: <span style="color:#000;font-weight:bold">(</span> Check_Nginx_Status.rc <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span> <span style="color:#000;font-weight:bold">)</span>  <span style="color:#998;font-style:italic">#只有Check_Nginx_Status.rc=0时,才会执行启动操作</span>
</span></span></code></pre></div><p>方案二</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager tasks<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat task_nginx.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#安装nginx</span>
</span></span><span style="display:flex;"><span>    - name: Installed nginx Server
</span></span><span style="display:flex;"><span>      yum: 
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#配置nginx</span>
</span></span><span style="display:flex;"><span>    - name: Configure nginx Server
</span></span><span style="display:flex;"><span>      template:
</span></span><span style="display:flex;"><span>        src: ./file/nginx.conf.j2
</span></span><span style="display:flex;"><span>        dest: /etc/nginx/nginx.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#检查nginx (Check_Nginx_Status=$(nginx -t))</span>
</span></span><span style="display:flex;"><span>    - name: Check Nginx Configure File
</span></span><span style="display:flex;"><span>      shell: nginx -t
</span></span><span style="display:flex;"><span>      register: Check_Nginx_Status
</span></span><span style="display:flex;"><span>      changed_when: 
</span></span><span style="display:flex;"><span>        - Check_Nginx_Status.stdout.find<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#39;successful&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#0086b3">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#启动Nginx</span>
</span></span><span style="display:flex;"><span>    - name: Systemd Nginx Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>        enabled: yes
</span></span></code></pre></div><p>方案三</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager tasks<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat task_nginx.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#安装nginx</span>
</span></span><span style="display:flex;"><span>    - name: Installed nginx Server
</span></span><span style="display:flex;"><span>      yum: 
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#配置nginx</span>
</span></span><span style="display:flex;"><span>    - name: Configure nginx Server
</span></span><span style="display:flex;"><span>      template:
</span></span><span style="display:flex;"><span>        src: ./file/nginx.conf.j2
</span></span><span style="display:flex;"><span>        dest: /etc/nginx/nginx.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#检查nginx (Check_Nginx_Status=$(nginx -t))</span>
</span></span><span style="display:flex;"><span>    - name: Check Nginx Configure File
</span></span><span style="display:flex;"><span>      shell: nginx -t
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#启动Nginx</span>
</span></span><span style="display:flex;"><span>    - name: Systemd Nginx Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>        enabled: yes
</span></span></code></pre></div></li>
<li>
<p>强制调用handlers 触发器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager tasks<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat task_nginx.yml </span>
</span></span><span style="display:flex;"><span>- hosts: webservers
</span></span><span style="display:flex;"><span>  force_handlers: yes	<span style="color:#998;font-style:italic">#无论tasks失败与否,只要通过过handlers,那me一定会执行</span>
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#安装nginx</span>
</span></span><span style="display:flex;"><span>    - name: Installed nginx Server
</span></span><span style="display:flex;"><span>      yum: 
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#配置nginx</span>
</span></span><span style="display:flex;"><span>    - name: Configure nginx Server
</span></span><span style="display:flex;"><span>      template:
</span></span><span style="display:flex;"><span>        src: ./file/nginx.conf.j2
</span></span><span style="display:flex;"><span>        dest: /etc/nginx/nginx.conf
</span></span><span style="display:flex;"><span>      notify: Restart Nginx Server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#检查nginx (Check_Nginx_Status=$(nginx -t))</span>
</span></span><span style="display:flex;"><span>    - name: Check Nginx Configure File
</span></span><span style="display:flex;"><span>      shell: nginx -t
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#启动Nginx</span>
</span></span><span style="display:flex;"><span>    - name: Systemd Nginx Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>        enabled: yes 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  handlers:
</span></span><span style="display:flex;"><span>    - name: Restart Nginx Server
</span></span><span style="display:flex;"><span>      systemd: 
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: restarted
</span></span></code></pre></div></li>
</ol>
<h2 id="九ansible-jinja2-模板">九、Ansible Jinja2 模板</h2>
<p><strong>1.jinja模板基本语法</strong>
<em>1）要想在配置文件中使用jinj2，playbook中的tasks 必须使用template模块</em></p>
<p><em>2）模板配置文件里面使用变量，比如 {{ PORT }} 或使用 {{ facts 变量 }}</em></p>
<p><strong>2.jinja模板逻辑关系</strong>
<em>{% for i in EXPR %}&hellip;{% endfor%} 作为循环表达式</em></p>
<p><em>{% if EXPR %}&hellip;{% elif EXPR %}&hellip;{% endif%} 作为条件判断</em></p>
<p><em>{# COMMENT #} 表示注释</em></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>% <span style="color:#000;font-weight:bold">for</span> i in range<span style="color:#000;font-weight:bold">(</span>1,10<span style="color:#000;font-weight:bold">)</span>%<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        server 172.16.1.<span style="color:#000;font-weight:bold">{{</span>i<span style="color:#000;font-weight:bold">}}</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>% endfor %<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#判断</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>% <span style="color:#000;font-weight:bold">if</span> <span style="color:#008080">ansible_fqdn</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;web01&#34;</span> %<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0086b3">echo</span> <span style="color:#099">123</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>% <span style="color:#000;font-weight:bold">elif</span> <span style="color:#008080">ansible_fqdn</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;web02&#34;</span> %<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0086b3">echo</span> <span style="color:#099">456</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>% <span style="color:#000;font-weight:bold">else</span> %<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0086b3">echo</span> <span style="color:#099">789</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>% endif %<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>nginxproxy配置文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager jinja2<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat j_nginx.yml </span>
</span></span><span style="display:flex;"><span>- hosts: lbservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#安装nginx</span>
</span></span><span style="display:flex;"><span>    - name: Installed nginx Server
</span></span><span style="display:flex;"><span>      yum: 
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#配置nginx vhosts</span>
</span></span><span style="display:flex;"><span>    - name: Configure nginx Server
</span></span><span style="display:flex;"><span>      template:
</span></span><span style="display:flex;"><span>        src: ./file/proxy_kod.oldxu.com.conf.j2
</span></span><span style="display:flex;"><span>        dest: /etc/nginx/conf.d/proxy_kod.oldxu.com.conf
</span></span><span style="display:flex;"><span>      notify: Restart Nginx Server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#998;font-style:italic">#启动Nginx</span>
</span></span><span style="display:flex;"><span>    - name: Systemd Nginx Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>        enabled: yes 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  handlers:
</span></span><span style="display:flex;"><span>    - name: Restart Nginx Server
</span></span><span style="display:flex;"><span>      systemd: 
</span></span><span style="display:flex;"><span>        name: nginx
</span></span><span style="display:flex;"><span>        state: restarted
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># nginx组变量   </span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager jinja2<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat group_vars/all </span>
</span></span><span style="display:flex;"><span>kod_http_port: <span style="color:#099">80</span>
</span></span><span style="display:flex;"><span>kod_server_name: kod.oldxu.com
</span></span><span style="display:flex;"><span>kod_web_site: /code/kod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#nginx proxy配置文件渲染</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager jinja2<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat file/proxy_kod.oldxu.com.conf.j2 </span>
</span></span><span style="display:flex;"><span>upstream <span style="color:#000;font-weight:bold">{{</span> kod_server_name <span style="color:#000;font-weight:bold">}}</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>% <span style="color:#000;font-weight:bold">for</span> host in groups<span style="color:#000;font-weight:bold">[</span><span style="color:#d14">&#39;webservers&#39;</span><span style="color:#000;font-weight:bold">]</span> %<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	server <span style="color:#000;font-weight:bold">{{</span>host<span style="color:#000;font-weight:bold">}}</span>:<span style="color:#000;font-weight:bold">{{</span>kod_http_port<span style="color:#000;font-weight:bold">}}</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>% endfor %<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>server <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	listen <span style="color:#000;font-weight:bold">{{</span> kod_http_port <span style="color:#000;font-weight:bold">}}</span>;
</span></span><span style="display:flex;"><span>	server_name  <span style="color:#000;font-weight:bold">{{</span> kod_server_name <span style="color:#000;font-weight:bold">}}</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	location / <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		proxy_pass http://<span style="color:#000;font-weight:bold">{{</span> kod_server_name <span style="color:#000;font-weight:bold">}}</span>;
</span></span><span style="display:flex;"><span>		proxy_set_header Host <span style="color:#008080">$http_hosts</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager jinja2<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat ../hosts</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>webservers<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>172.16.1.7
</span></span><span style="display:flex;"><span>172.16.1.8
</span></span></code></pre></div><p>2.Keepalived配置文件   master   slave</p>
<pre><code>1.准备多个配置文件   master   backup
</code></pre>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager jinja2<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat j_keepalived.yml </span>
</span></span><span style="display:flex;"><span>- hosts: lbservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Installed Keepalived Server
</span></span><span style="display:flex;"><span>      yum:
</span></span><span style="display:flex;"><span>        name: keepalived
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Configure Keepalived Master
</span></span><span style="display:flex;"><span>      copy:
</span></span><span style="display:flex;"><span>        src: ./file/keepalived-master.conf.j2
</span></span><span style="display:flex;"><span>        dest: /etc/keepalived/keepalived.conf
</span></span><span style="display:flex;"><span>      when: <span style="color:#000;font-weight:bold">(</span> <span style="color:#008080">ansible_hostname</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;lb01&#34;</span> <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      notify: Restart Keepalived Server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Configure Keepalived Backup
</span></span><span style="display:flex;"><span>      copy:
</span></span><span style="display:flex;"><span>        src: ./file/keepalived-backup.conf.j2
</span></span><span style="display:flex;"><span>        dest: /etc/keepalived/keepalived.conf
</span></span><span style="display:flex;"><span>      when: <span style="color:#000;font-weight:bold">(</span> <span style="color:#008080">ansible_hostname</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;lb02&#34;</span> <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      notify: Restart Keepalived Server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Systemd Keepalived Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: keepalived
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>        enabled: yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  handlers:
</span></span><span style="display:flex;"><span>    - name: Restart Keepalived Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: keepalived
</span></span><span style="display:flex;"><span>        state: restarted
</span></span></code></pre></div><pre><code>2.设定host_vars变量  5和6设定相同的变量,不同的值
</code></pre>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic">#1.准备一份keepalived配置文件</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#2.需要在keepalived配置文件中使用变量方式  ---&gt; jinja</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager jinja2<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat ./file/keepalived-vars.conf.j2 </span>
</span></span><span style="display:flex;"><span>global_defs <span style="color:#000;font-weight:bold">{</span>     
</span></span><span style="display:flex;"><span>    router_id <span style="color:#000;font-weight:bold">{{</span> ansible_hostname <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    state  <span style="color:#000;font-weight:bold">{{</span> state <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>    priority <span style="color:#000;font-weight:bold">{{</span> priority <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    interface eth0
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#099">50</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass <span style="color:#099">1111</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        10.0.0.3
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager jinja2<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat host_vars/172.16.1.5</span>
</span></span><span style="display:flex;"><span>state: MASTER
</span></span><span style="display:flex;"><span>priority: <span style="color:#099">200</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager jinja2<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat host_vars/172.16.1.6</span>
</span></span><span style="display:flex;"><span>state: BACKUP
</span></span><span style="display:flex;"><span>priority: <span style="color:#099">99</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager jinja2<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat var_keepalived.yml </span>
</span></span><span style="display:flex;"><span>- hosts: lbservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Installed Keepalived Server
</span></span><span style="display:flex;"><span>      yum:
</span></span><span style="display:flex;"><span>        name: keepalived
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Configure Keepalived Master
</span></span><span style="display:flex;"><span>      template:
</span></span><span style="display:flex;"><span>        src: ./file/keepalived-vars.conf.j2
</span></span><span style="display:flex;"><span>        dest: /etc/keepalived/keepalived.conf
</span></span><span style="display:flex;"><span>      notify: Restart Keepalived Server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Systemd Keepalived Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: keepalived
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>        enabled: yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  handlers:
</span></span><span style="display:flex;"><span>    - name: Restart Keepalived Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: keepalived
</span></span><span style="display:flex;"><span>        state: restarted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#为不同的主机设定相同的变量,  只不过值不一样.</span>
</span></span></code></pre></div><p>3.jinja2判断方式</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager jinja2<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat jinja_keepalived.yml </span>
</span></span><span style="display:flex;"><span>- hosts: lbservers
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Installed Keepalived Server
</span></span><span style="display:flex;"><span>      yum:
</span></span><span style="display:flex;"><span>        name: keepalived
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Configure Keepalived Master
</span></span><span style="display:flex;"><span>      template:
</span></span><span style="display:flex;"><span>        src: ./file/keepalived.conf.j2
</span></span><span style="display:flex;"><span>        dest: /etc/keepalived/keepalived.conf
</span></span><span style="display:flex;"><span>      notify: Restart Keepalived Server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - name: Systemd Keepalived Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: keepalived
</span></span><span style="display:flex;"><span>        state: started
</span></span><span style="display:flex;"><span>        enabled: yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  handlers:
</span></span><span style="display:flex;"><span>    - name: Restart Keepalived Server
</span></span><span style="display:flex;"><span>      systemd:
</span></span><span style="display:flex;"><span>        name: keepalived
</span></span><span style="display:flex;"><span>        state: restarted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@manager jinja2<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat file/keepalived.conf.j2 </span>
</span></span><span style="display:flex;"><span>global_defs <span style="color:#000;font-weight:bold">{</span>     
</span></span><span style="display:flex;"><span>    router_id <span style="color:#000;font-weight:bold">{{</span> ansible_hostname <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vrrp_instance VI_1 <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>% <span style="color:#000;font-weight:bold">if</span> <span style="color:#008080">ansible_hostname</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;lb01&#34;</span> %<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    state  MASTER
</span></span><span style="display:flex;"><span>    priority <span style="color:#099">150</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>% <span style="color:#000;font-weight:bold">elif</span> <span style="color:#008080">ansible_hostname</span> <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;lb02&#34;</span> %<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    state  BACKUP
</span></span><span style="display:flex;"><span>    priority <span style="color:#099">100</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>% endif %<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#########################相同的内容</span>
</span></span><span style="display:flex;"><span>    interface eth0
</span></span><span style="display:flex;"><span>    virtual_router_id <span style="color:#099">50</span>
</span></span><span style="display:flex;"><span>    advert_int <span style="color:#099">1</span>
</span></span><span style="display:flex;"><span>    authentication <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        auth_type PASS
</span></span><span style="display:flex;"><span>        auth_pass <span style="color:#099">1111</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    virtual_ipaddress <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        10.0.0.3
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="十ansible-roles角色">十、Ansible Roles角色</h2>
<h4 id="1-使用roles创建rsync服务">1. 使用Roles创建Rsync服务</h4>
<ol>
<li>Playbook Roles目录结构</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># tree /etc/ansible/roles/</span>
</span></span><span style="display:flex;"><span>/etc/ansible/roles/
</span></span><span style="display:flex;"><span>├── hosts
</span></span><span style="display:flex;"><span>├── rsync
</span></span><span style="display:flex;"><span>│   ├── files
</span></span><span style="display:flex;"><span>│   │   ├── rsyncd.conf
</span></span><span style="display:flex;"><span>│   │   └── rsync.passwd
</span></span><span style="display:flex;"><span>│   ├── handlers
</span></span><span style="display:flex;"><span>│   │   └── main.yml
</span></span><span style="display:flex;"><span>│   ├── tasks
</span></span><span style="display:flex;"><span>│   │   └── main.yml
</span></span><span style="display:flex;"><span>│   ├── templates
</span></span><span style="display:flex;"><span>│   └── vars
</span></span><span style="display:flex;"><span>├── site.yml
</span></span></code></pre></div><ol start="2">
<li>定义roles主机清单</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/ansible/roles/hosts </span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>backup<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>172.16.1.41
</span></span></code></pre></div><ol start="3">
<li>指定backup主机组，执行那个roles</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/ansible/roles/site.yml </span>
</span></span><span style="display:flex;"><span>- hosts: backup
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  roles:
</span></span><span style="display:flex;"><span>    - rsync
</span></span></code></pre></div><ol start="4">
<li>查看rsync角色的tasks任务</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/ansible/roles/rsync/tasks/main.yml </span>
</span></span><span style="display:flex;"><span>- name: Install Rsync Server
</span></span><span style="display:flex;"><span>  yum: <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span>rsync <span style="color:#008080">state</span><span style="color:#000;font-weight:bold">=</span>present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- name: Configure Rsync Server
</span></span><span style="display:flex;"><span>  copy: <span style="color:#008080">src</span><span style="color:#000;font-weight:bold">={{</span> item.src <span style="color:#000;font-weight:bold">}}</span> <span style="color:#008080">dest</span><span style="color:#000;font-weight:bold">=</span>/etc/<span style="color:#000;font-weight:bold">{{</span> item.dest <span style="color:#000;font-weight:bold">}}</span> <span style="color:#008080">mode</span><span style="color:#000;font-weight:bold">={{</span> item.mode <span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>  with_items:
</span></span><span style="display:flex;"><span>    - <span style="color:#000;font-weight:bold">{</span>src: <span style="color:#d14">&#34;rsyncd.conf&#34;</span>, dest: <span style="color:#d14">&#34;rsyncd.conf&#34;</span>, mode: <span style="color:#d14">&#34;0644&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#000;font-weight:bold">{</span>src: <span style="color:#d14">&#34;rsync.passwd&#34;</span>, dest: <span style="color:#d14">&#34;rsync.passwd&#34;</span>, mode: <span style="color:#d14">&#34;0600&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  notify: Restart Rsync Server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- name: Start Rsync Server
</span></span><span style="display:flex;"><span>  service: <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span>rsyncd <span style="color:#008080">state</span><span style="color:#000;font-weight:bold">=</span>started <span style="color:#008080">enabled</span><span style="color:#000;font-weight:bold">=</span>yes
</span></span></code></pre></div><ol start="5">
<li>查看rsync角色的handlers</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/ansible/roles/rsync/handlers/main.yml </span>
</span></span><span style="display:flex;"><span>- name: Restart Rsync Server
</span></span><span style="display:flex;"><span>  service: <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span>rsyncd <span style="color:#008080">state</span><span style="color:#000;font-weight:bold">=</span>restarted
</span></span></code></pre></div><ol start="6">
<li>查看rsync角色的files目录</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic">#  ll /etc/ansible/roles/rsync/files/</span>
</span></span><span style="display:flex;"><span>total <span style="color:#099">8</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#099">1</span> root root <span style="color:#099">322</span> Nov <span style="color:#099">16</span> 18:49 rsyncd.conf
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#099">1</span> root root  <span style="color:#099">20</span> Nov <span style="color:#099">16</span> 18:30 rsync.passwd
</span></span></code></pre></div><ol start="7">
<li>执行roles，使用-t指定执行测试rsync角色</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible-playbook -i hosts  -t rsync site.yml </span>
</span></span><span style="display:flex;"><span>PLAY <span style="color:#000;font-weight:bold">[</span>backup<span style="color:#000;font-weight:bold">]</span> ********************************************************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#000;font-weight:bold">[</span>Gathering Facts<span style="color:#000;font-weight:bold">]</span> ********************************************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#000;font-weight:bold">[</span>172.16.1.41<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#000;font-weight:bold">[</span>backup : Install Rsync Server<span style="color:#000;font-weight:bold">]</span> ***********************************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#000;font-weight:bold">[</span>172.16.1.41<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#000;font-weight:bold">[</span>backup : Configure Rsync Server<span style="color:#000;font-weight:bold">]</span> *********************************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#000;font-weight:bold">[</span>172.16.1.41<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#000;font-weight:bold">[</span>backup : Start Rsync Server<span style="color:#000;font-weight:bold">]</span> *************************************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#000;font-weight:bold">[</span>172.16.1.41<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY RECAP ********************************************************************************************
</span></span><span style="display:flex;"><span>172.16.1.41                : <span style="color:#008080">ok</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">5</span>    <span style="color:#008080">changed</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>    <span style="color:#008080">unreachable</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>    <span style="color:#008080">failed</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>  
</span></span></code></pre></div><h4 id="2-使用rloes创建nfs服务">2. 使用Rloes创建NFS服务</h4>
<ol>
<li>使用roles创建Nfs服务, 目录结构如下</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># tree /etc/ansible/roles</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>├── group_vars
</span></span><span style="display:flex;"><span>│   └── all
</span></span><span style="display:flex;"><span>├── hosts
</span></span><span style="display:flex;"><span>├── nfs
</span></span><span style="display:flex;"><span>│   ├── files
</span></span><span style="display:flex;"><span>│   ├── handlers
</span></span><span style="display:flex;"><span>│   │   └── main.yml
</span></span><span style="display:flex;"><span>│   ├── tasks
</span></span><span style="display:flex;"><span>│   │   └── main.yml
</span></span><span style="display:flex;"><span>│   ├── templates
</span></span><span style="display:flex;"><span>│   │   └── exports
</span></span><span style="display:flex;"><span>│   └── vars
</span></span><span style="display:flex;"><span>├── site.yml
</span></span></code></pre></div><ol start="2">
<li>定义roles主机清单</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/ansible/roles/hosts </span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>nfs<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>172.16.1.31
</span></span></code></pre></div><ol start="3">
<li>指定nfs主机组，执行那个roles</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/ansible/roles/site.yml </span>
</span></span><span style="display:flex;"><span>- hosts: nfs
</span></span><span style="display:flex;"><span>  remote_user: root
</span></span><span style="display:flex;"><span>  roles:
</span></span><span style="display:flex;"><span>    - nfs
</span></span><span style="display:flex;"><span>  tags: nfs
</span></span></code></pre></div><ol start="4">
<li>查看nfs角色的tasks任务</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/ansible/roles/nfs/tasks/main.yml </span>
</span></span><span style="display:flex;"><span>- name: Install Nfs-Server
</span></span><span style="display:flex;"><span>  yum: <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span>nfs-utils <span style="color:#008080">state</span><span style="color:#000;font-weight:bold">=</span>present
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- name: Configure Nfs-Server
</span></span><span style="display:flex;"><span>  template: <span style="color:#008080">src</span><span style="color:#000;font-weight:bold">=</span>exports <span style="color:#008080">dest</span><span style="color:#000;font-weight:bold">=</span>/etc/exports
</span></span><span style="display:flex;"><span>  notify: Restart Nfs-Server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- name: Create Directory Data
</span></span><span style="display:flex;"><span>  file: <span style="color:#008080">path</span><span style="color:#000;font-weight:bold">={{</span> share_dir <span style="color:#000;font-weight:bold">}}</span> <span style="color:#008080">state</span><span style="color:#000;font-weight:bold">=</span>directory <span style="color:#008080">owner</span><span style="color:#000;font-weight:bold">=</span>www <span style="color:#008080">group</span><span style="color:#000;font-weight:bold">=</span>www <span style="color:#008080">mode</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0755</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- name: Start Nfs-Server
</span></span><span style="display:flex;"><span>  service: <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span>nfs <span style="color:#008080">state</span><span style="color:#000;font-weight:bold">=</span>started <span style="color:#008080">enabled</span><span style="color:#000;font-weight:bold">=</span>yes
</span></span></code></pre></div><ol start="5">
<li>查看nfs角色的handlers</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/ansible/roles/nfs/handlers/main.yml </span>
</span></span><span style="display:flex;"><span>- name: Restart Nfs-Server
</span></span><span style="display:flex;"><span>  service: <span style="color:#008080">name</span><span style="color:#000;font-weight:bold">=</span>nfs <span style="color:#008080">state</span><span style="color:#000;font-weight:bold">=</span>restarted
</span></span></code></pre></div><ol start="6">
<li>查看rsync角色的files目录</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/ansible/roles/nfs/templates/exports </span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{{</span> share_dir <span style="color:#000;font-weight:bold">}}</span> <span style="color:#000;font-weight:bold">{{</span> share_ip <span style="color:#000;font-weight:bold">}}(</span>rw,sync,all_squash,anonuid<span style="color:#000;font-weight:bold">=</span>666,anongid<span style="color:#000;font-weight:bold">=</span>666<span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><ol start="7">
<li>nfs对应的变量定义</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat /etc/ansible/roles/group_vars/all </span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">#nfs</span>
</span></span><span style="display:flex;"><span>share_dir: /data
</span></span><span style="display:flex;"><span>share_ip: 172.16.1.31
</span></span></code></pre></div><ol start="8">
<li>执行roles，使用-t指定执行nfs标签</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@m01 roles<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible-playbook -i hosts  -t nfs site.yml </span>
</span></span><span style="display:flex;"><span>PLAY <span style="color:#000;font-weight:bold">[</span>nfs<span style="color:#000;font-weight:bold">]</span> ********************************************************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#000;font-weight:bold">[</span>Gathering Facts<span style="color:#000;font-weight:bold">]</span> ********************************************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#000;font-weight:bold">[</span>172.16.1.31<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#000;font-weight:bold">[</span>nfs : Install Nfs-Server<span style="color:#000;font-weight:bold">]</span> ***********************************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#000;font-weight:bold">[</span>172.16.1.31<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#000;font-weight:bold">[</span>nfs : Configure Nfs-Server<span style="color:#000;font-weight:bold">]</span> *********************************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#000;font-weight:bold">[</span>172.16.1.31<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#000;font-weight:bold">[</span>nfs : Create Directory Data<span style="color:#000;font-weight:bold">]</span> ********************************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#000;font-weight:bold">[</span>172.16.1.31<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#000;font-weight:bold">[</span>nfs : Start Nfs-Server<span style="color:#000;font-weight:bold">]</span> *************************************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#000;font-weight:bold">[</span>172.16.1.31<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY RECAP ********************************************************************************************
</span></span><span style="display:flex;"><span>172.16.1.31                : <span style="color:#008080">ok</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">5</span>    <span style="color:#008080">changed</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>    <span style="color:#008080">unreachable</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>    <span style="color:#008080">failed</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>   
</span></span></code></pre></div><h2 id="十一实战">十一、实战</h2>
<p>批量推送密钥</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@jitlab role<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># cat pushkey.yml </span>
</span></span><span style="display:flex;"><span>- hosts: all
</span></span><span style="display:flex;"><span>  tasks:
</span></span><span style="display:flex;"><span>    - name: Push Pbulic Key
</span></span><span style="display:flex;"><span>      authorized_key:
</span></span><span style="display:flex;"><span>        user: root
</span></span><span style="display:flex;"><span>        state: present
</span></span><span style="display:flex;"><span>        key: <span style="color:#d14">&#34;{{ lookup(&#39;file&#39;, &#39;/root/.ssh/id_rsa.pub&#39;) }}&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">[</span>root@jitlab role<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># ansible-playbook -i hosts pushkey.yml -k</span>
</span></span><span style="display:flex;"><span>SSH password: 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY <span style="color:#000;font-weight:bold">[</span>all<span style="color:#000;font-weight:bold">]</span> ***********************************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#000;font-weight:bold">[</span>Gathering Facts<span style="color:#000;font-weight:bold">]</span> ***********************************************************
</span></span><span style="display:flex;"><span>ok: <span style="color:#000;font-weight:bold">[</span>172.16.1.7<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>ok: <span style="color:#000;font-weight:bold">[</span>172.16.1.8<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#000;font-weight:bold">[</span>Push Pbulic Key<span style="color:#000;font-weight:bold">]</span> ***********************************************************
</span></span><span style="display:flex;"><span>changed: <span style="color:#000;font-weight:bold">[</span>172.16.1.7<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>changed: <span style="color:#000;font-weight:bold">[</span>172.16.1.8<span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PLAY RECAP ***********************************************************************
</span></span><span style="display:flex;"><span>172.16.1.7                 : <span style="color:#008080">ok</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">2</span>    <span style="color:#008080">changed</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>    <span style="color:#008080">unreachable</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>    <span style="color:#008080">failed</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>    <span style="color:#008080">skipped</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>    <span style="color:#008080">rescued</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>    <span style="color:#008080">ignored</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>   
</span></span><span style="display:flex;"><span>172.16.1.8                 : <span style="color:#008080">ok</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">2</span>    <span style="color:#008080">changed</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span>    <span style="color:#008080">unreachable</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>    <span style="color:#008080">failed</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>    <span style="color:#008080">skipped</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>    <span style="color:#008080">rescued</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>    <span style="color:#008080">ignored</span><span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>   
</span></span></code></pre></div><h2 id="十二小技巧">十二、小技巧</h2>
<h4 id="1-取ip地址最后一位">1. 取IP地址最后一位</h4>
<p>以<code>.</code>为分隔符，取最后一列</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{{</span> ansible_default_ipv4.address.split<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#39;.&#39;</span><span style="color:#000;font-weight:bold">)[</span>-1<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}}</span>
</span></span></code></pre></div>
    </div>

    

    

    
    
    

    
</div>

        </div>
        <div id="footer"><div class="container-footer">
    
    <a href="" target="_blank">
        
        <span class="some">enter your icp or a interesting slogan...<span>
        
    </a>
    <a id="s" href="/secrets">&nbsp;</a>
    
</div></div>
    </body>
</html>
